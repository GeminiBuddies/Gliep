%token: int id
%root: Program

Program     : Block
            ;

Block       : ( Expr ';'?)*
            ;

# Expr eats tokens greedily
# earlier appearence, higher precedence
Expr        : ExprItem
            | Expr Expr
            | Expr "$" Expr
            | Expr "." identifier
            | Expr "@" Expr
            | Expr ( "*" | "/" | "%" ) Expr
            | Expr ( "+" | "-" ) Expr
            | Expr ( "<<" | ">>" ) Expr
            | Expr ( ">" | "<" | ">=" | "<=" ) Expr
            | Expr ( "==" | "~=" ) Expr
            | Expr "&" Expr
            | Expr "^" Expr
            | Expr "|" Expr
            | Expr "=" Expr
            ;

# ExprItem also eats tokens greedily
ExprItem    : literal
            | identifier
            | "!" identifier
            | "!!" identifier
            | TableDef
            | "-" ExprItem
            | "~" ExprItem
            | "`" ExprItem
            | BlockInParen
            | If
            | While
            | Return
            | Function
            | Lambda
            | OnStackList
            ;

TableDef    : "{" (TableDef ("," TableDef)*)? "}"
                ;

TableDef    : (("@"? Expr ) | ("." identifier)) ":" Expr
                    ;

BlockInParen    : "(" Block ")"
                ;

If          : "if" BlockInParen Expr ( "elif" BlockInParen Expr )* ( "else" Expr )?
            ;

While       : "while" BlockInParen Expr
            ;

Return      : "return" Expr
            ;

Function    : "fn" identifier? OptionalParamList OptionalRightArrow Expr
            ;

OptionalParamList   : ( "[" (identifier ("," identifier)*)? "]" )?
                    ;

OptionalRightArrow  : "->"?
                    ;

Lambda      : (OnStackList | identifier ) "->" expr
            ;

OnStackList : "[" (Expr ("," Expr)*)? "]"
            ;
